<!DOCTYPE html>
<html>
<head>
  <title>Monitor de Audio MUPPET</title>
  <style>
    .meter {
      width: 80%; height: 30px;
      border: 1px solid #ccc;
      margin: 20px auto;
    }
    .level {
      height: 100%;
      background: #4CAF50;
      width: 0%;
    }
  </style>
</head>
<body>
  <h1>Monitor de Audio</h1>
  <div class="meter">
    <div id="audioLevel" class="level"></div>
  </div>
  <div id="value">0%</div>
  <button id="startBtn">Iniciar Micr贸fono</button>
  
  <script>
    const startBtn = document.getElementById('startBtn');
    const audioLevel = document.getElementById('audioLevel');
    const valueDisplay = document.getElementById('value');
    let isRunning = false;

    startBtn.addEventListener('click', async () => {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        const audioContext = new AudioContext();
        const analyser = audioContext.createAnalyser();
        const microphone = audioContext.createMediaStreamSource(stream);
        microphone.connect(analyser);
        
        analyser.fftSize = 32;
        const dataArray = new Uint8Array(analyser.frequencyBinCount);
        
        function sendDataToESP(level) {
          // Enviar datos al ESP8266 (ajusta la IP)
          fetch('http://192.168.4.1/data?level=' + level)
            .catch(err => console.log("Error enviando datos:", err));
        }

        function processAudio() {
          analyser.getByteFrequencyData(dataArray);
          let sum = dataArray.reduce((a, b) => a + b, 0);
          let average = sum / dataArray.length;
          let percentage = Math.min(100, Math.round(average / 255 * 100));
          
          audioLevel.style.width = percentage + '%';
          valueDisplay.textContent = percentage + '%';
          sendDataToESP(percentage);
          
          if(isRunning) requestAnimationFrame(processAudio);
        }
        
        isRunning = true;
        processAudio();
        startBtn.textContent = "Detener Micr贸fono";
        startBtn.onclick = () => {
          isRunning = false;
          stream.getTracks().forEach(track => track.stop());
          startBtn.textContent = "Iniciar Micr贸fono";
          startBtn.onclick = startBtn.addEventListener('click', arguments.callee);
        };
        
      } catch(err) {
        console.error("Error:", err);
        alert("No se pudo acceder al micr贸fono: " + err.message);
      }
    });
  </script>
</body>
</html>
